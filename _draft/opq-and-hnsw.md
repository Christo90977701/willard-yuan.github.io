---
layout: post
title: 图像检索：OPQ索引与HNSW索引
categories: [Image Retrieval]
tags: CBIR
---

> 人的独立性和参与性必须适得其所，平衡发展。一方面，过分的参与必然导致远离自我核心，现代人之所以感到空虚、无聊，在很大程度上就是由于顺从、依赖和参与过多，脱离了自我核心。另一方面，过分的独立会将自己束缚在狭小的自我世界内，缺乏正常的交往，必然损害人的正常发展。

本文主要是小白菜以OPQ、HNSW为代表，关于索引的一些总结与思考。

关于索引结构，有千千万万，而在图像检索里，索引主要是为快速检索而设计的一种数据结构。工业中常用的索引方法主要以倒排、[PQ](http://yongyuan.name/blog/ann-search.html)和[哈希](https://github.com/willard-yuan/hashing-baseline-for-image-retrieval)（其中哈希又以LSH和[ITQ](http://yongyuan.name/blog/itq-hashing.html)为主）为主流。[Rasmus Pagh](http://www.itu.dk/people/pagh/)发起的大规模相似搜索项目[ANN-Benchmarks](http://sss.projects.itu.dk/ann-benchmarks/)、Faiss以及[ann-benchmarks](https://github.com/erikbern/ann-benchmarks)都有对一些主流的方法做过对比，虽然三个对比的框架，对不同方法的性能均有出入，但一些主流方法的性能差异是可以达成共识的，比如基于图方法的ANN其召回率均要优于其他方法。




### 数据实验说明

199485332条人脸数据（128维，L2归一化）作为database, 10000条人脸数据作为查询。gound truth由暴力搜索结果产生（余弦相似度），将暴力搜索结果的rank@1作为gound truth，评估top@K下的召回率。

### 实验结果与调优

M参数：80，内存大小: 159364 Mb，索引文件：`cnn2b_199485332m_ef_80_M_32_ip.bin`，查询样本数目: 10000，ef: 1000，距离：内积距离

top@K | 召回 | 时间(time(us) per query)
---|---|---
1 | 0.957000 | -
2 |	0.977300 | 9754.885742us
3 | 0.981200 | 9619.380859us
4 |	0.983100 | 9652.819336us
5 | 0.983800 | 9628.488281us
10 | 0.984500 | 9650.678711us
50 | 0.986400 | 9647.286133us
100 | 0.986700 | 9665.638672us
300 | 0.987000 | 9685.414062us
500 | 0.987100 | 9744.437500us
1000 | 0.987100 | 9804.702148us

![image](http://ose5hybez.bkt.clouddn.com/notes/hnsw_face_2b.jpg)

M参数：16，Mem: 173442 Mb， 索引文件：`cnn2b_199485332m_ef_40_M_16.bin`, 查询样本数目: 10000，ef: 1000，距离：欧氏距离

top@K | 召回 | 时间(time_us_per_query)
---|---|---
1 | 0.887800 | 4845.700684us
2 | 0.911700 | 6732.230957us
3 | 0.916600 | 6879.585449us
4 | 0.917500 | 6963.914062us
5 | 0.918000 | 6920.318359us
10| 0.920200 | 6880.795898us
50 | 0.922400 | 6900.778809us
100 | 0.923000 | 6970.664062us
300 | 0.923400 | 6978.517578us
500 | 0.923400 | 6992.306152us

M参数：40，Mem: 211533 Mb， 索引文件：`cnn2b_199485332m_ef_40_M_40.bin`, 查询样本数目: 10000，ef: 1000，距离：内积距离

top@K | 召回 | 时间(time_us_per_query)
---|---|---
1 | 0.928600 | 6448.714355us
2 | 0.948300 | 7658.459961us
3 | 0.952600 | 7674.244629us
4 | 0.954000 | 7659.506348us
5 | 0.954700 | 7679.874023us
10 | 0.955800 | 7709.812500us
50 |0.957400 | 7720.283691us
100 | 0.957800 | 7722.512695us
300 | 0.958000 | 7763.615234us
500 | 0.958100 | 7779.351562us
1000| 0.958100 | 7859.372559us